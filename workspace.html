/**
 * SCRUMMER â€” Copilot Logic
 */
(() => {
    const $ = (id) => document.getElementById(id);
    const compute = window.Scrummer?.computeSignals;
    const setupApi = window.Scrummer?.setup;

    const ceremonyData = {
        planning: {
            title: "Sprint Planning Guide",
            why: "Focus on balancing commitment against the historical average to protect delivery confidence.",
            points: (s) => [
                `Current load is ${Math.round(s.overcommitRatio * 100)}% of capacity. Discuss if this is sustainable.`,
                `Velocity volatility is ${Math.round(s.vol * 100)}%. Recommend a 10% buffer for unknown technical debt.`,
                `Capacity health is ${s.capacityHealth}. Prioritize 'Must-Have' items first.`
            ]
        },
        daily: {
            title: "Daily Standup Guide",
            why: "Use these signals to identify hidden blockers before they become delays.",
            points: (s) => [
                `Focus Factor is ${Math.round(s.focusFactor * 100)}%. Are meetings distracting from development?`,
                `Risk is ${s.riskScore}%. Identify the single biggest ticket blocking the Sprint Goal.`,
                `Ask: 'If we could only finish ONE thing today, what would it be?'`
            ]
        },
        refine: {
            title: "Backlog Refinement",
            why: "Aim to reduce volatility by improving story slicing.",
            points: (s) => [
                `Volatility is high. Look for stories > 5SP and split them into smaller units.`,
                `Ensure 'Definition of Ready' is met for the next ${Math.round(s.avgVelocity)} points of work.`,
                `Validate acceptance criteria for the top 3 items.`
            ]
        }
    };

    function updateCopilot(tab) {
        const s = compute(setupApi.loadSetup());
        const data = ceremonyData[tab] || ceremonyData.planning;

        $("panelTitle").innerText = data.title;
        $("panelWhy").innerText = data.why;
        
        const listHtml = data.points(s).map(p => `<li>${p}</li>`).join('');
        $("panelList").innerHTML = listHtml;

        // Update Brief KPIs
        $("briefScope").innerText = `${Math.round(s.overcommitRatio * 100)}%`;
        $("briefCapRatio").innerText = `${Math.round(s.focusFactor * 100)}%`;
        $("briefConf").innerText = `${s.confidence}%`;
        $("briefRisk").innerText = `${s.riskScore}%`;
    }

    // Tab Switching
    document.querySelectorAll('.segBtn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.segBtn').forEach(b => b.classList.remove('active', 'is-active'));
            btn.classList.add('is-active');
            updateCopilot(btn.getAttribute('data-tab'));
        };
    });

    // Initialize
    if (compute && setupApi) {
        updateCopilot('planning');
    }
})();
