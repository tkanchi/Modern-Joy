<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Scrummer ‚Äî Forecast</title>
  <link rel="stylesheet" href="css/style.css?v=3"/>
</head>

<body>
  <div class="appShell">

    <!-- SIDEBAR -->
    <aside class="sideNav">
      <div class="sideBrand">
        <div class="brandMark">üêÜ</div>
        <div>
          <div class="brandName">SCRUMMER</div>
          <div class="brandTag">Gamified Scrum OS</div>
        </div>
      </div>

      <nav class="nav">
        <a class="navlink" href="index.html">üöÄ Setup</a>
        <a class="navlink" href="intelligence.html">üìä Insights</a>
        <a class="navlink" href="suggestions.html">üéØ Actions</a>
        <a class="navlink" href="workspace.html">ü§ñ Copilot</a>
        <a class="navlink active" href="forecast.html">üì¶ Forecast</a>
        <a class="navlink" href="gamerules.html">üéÆ Game Rules</a>
      </nav>
 <a class="navlink" href="auth.html">üîê Account</a>

      <!-- XP WIDGET -->
      <div class="xpWidget">
        <div class="xpTop">
          <div>
            <div class="lvl" id="xpLevel">Level 1</div>
            <div class="title" id="xpTitle">Rookie</div>
          </div>
          <div id="moodBadge">üêÜ Calm</div>
        </div>

        <div class="xpBar">
          <div class="xpFill" id="xpFill"></div>
        </div>

        <div class="xpMeta">
          <span id="xpText">0 / 300 XP</span>
          <span id="streakText">üßä streak reset</span>
        </div>
      </div>

      <button class="themeToggle" id="themeToggle" type="button">
        Theme: <span id="themeMode">Light</span>
      </button>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="sectionCard">
        <h1 class="sectionTitle">Capacity Forecast</h1>
        <p class="sectionSub">Pure math. Transparent formulas. No AI. No hidden assumptions.</p>

        <div class="info-banner">
          <strong>Purpose:</strong> Estimate realistic Sprint commitment before planning begins.
        </div>

        <!-- ===================================================== -->
        <!-- FORECAST MATH EXPLANATION -->
        <!-- ===================================================== -->
        <div class="info-banner" style="margin-top:14px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:900;">üìñ How Forecast Is Calculated</div>
            <button class="btnGhost" type="button" id="toggleExplain" style="padding:6px 10px; font-size:12px;">
              Show Details
            </button>
          </div>

          <div id="explainBox" style="display:none; margin-top:14px; color:var(--text-muted); font-weight:800; line-height:1.6;">

            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">1) Raw Capacity</div>
              Raw Capacity = Sprint Days √ó Team Members
              <div style="margin-top:6px;">
                Total theoretical working days before accounting for leave or interruptions.
              </div>
            </div>

            <!-- ‚úÖ Improved: interruptions explanation + example -->
            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">2) Effective Team Days</div>
              Effective Days = (Raw Capacity ‚àí Leave Days) √ó (1 ‚àí Interruptions%)

              <div style="margin-top:6px;">
                First subtract time-off, then reduce remaining capacity by expected overhead (support work, meetings, production issues).
              </div>

              <div style="margin-top:8px;">
                <b>Why (1 ‚àí Interruptions%)?</b>
              </div>

              <div style="margin-top:6px;">
                If interruptions are 20%, it means <b>20% of remaining time is NOT usable</b> for sprint work.
                So usable time = 100% ‚àí 20% = 80% ‚Üí multiply by 0.80.
              </div>

              <div style="margin-top:8px;">
                <b>Mini example:</b>
                <div style="margin-top:6px;">
                  Raw Capacity = 10 days √ó 7 people = 70 team-days<br/>
                  Leave Days = 5 ‚Üí remaining = 65 team-days<br/>
                  Interruptions = 20% ‚Üí usable = 65 √ó 0.80 = <b>52 effective team-days</b>
                </div>
              </div>

              <div style="margin-top:8px;">
                Percentages always reduce proportionally ‚Äî that‚Äôs why we multiply by (1 ‚àí Interruptions%), not subtract ‚Äúdays‚Äù directly.
              </div>
            </div>

            <!-- ‚úÖ Improved: why divide by Raw Capacity -->
            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">3) Velocity per Team Day</div>
              Velocity/Day = Average Velocity √∑ Raw Capacity
              <div style="margin-top:6px;">
                Converts historical output into delivery rate per team-day.
              </div>
              <div style="margin-top:6px;">
                <b>Why divide by Raw Capacity (not Effective Days)?</b><br/>
                Because historical velocity was achieved under full sprint context.
                We use Raw Capacity as the stable denominator, then apply your leave/interruptions via Effective Days.
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">4) Forecast Story Points</div>
              Forecast SP = Effective Days √ó Velocity/Day
              <div style="margin-top:6px;">
                Realistic estimate based on usable time and past throughput.
              </div>
            </div>

            <div style="margin-top:10px;">
              <div style="font-weight:900; color:var(--text-main);">Commitment Range</div>
              Conservative = Forecast ‚àí 10% <br/>
              Likely = Forecast <br/>
              Stretch = Forecast + 5%
              <div style="margin-top:6px;">
                Forecasting is probabilistic, so we show a safe band instead of a single number.
              </div>
            </div>

            <div style="margin-top:14px; font-size:12px;">
              Based on standard Scrum capacity planning concepts, Sprint Planning guidance,
              and industry practices around velocity and focus factor.
            </div>

          </div>
        </div>

        <!-- ===================================================== -->
        <!-- ESTIMATION SCALE COMPATIBILITY -->
        <!-- ===================================================== -->
        <div class="info-banner" style="margin-top:14px;">
          <div style="font-weight:900;">üìè Estimation Scale Compatibility</div>

          <div style="margin-top:8px; color:var(--text-muted); font-weight:800; line-height:1.6;">
            Scrummer Forecast works with any consistent estimation scale, as long as your historical velocity uses the same scale.
          </div>

          <div style="margin-top:8px; color:var(--text-muted); font-weight:800; line-height:1.6; white-space:pre-line;">
‚Ä¢ Fibonacci (1, 2, 3, 5, 8, 13‚Ä¶)
‚Ä¢ Modified scales (1, 2, 4, 6, 8, 16, 32‚Ä¶) ‚úÖ
‚Ä¢ Linear scales (1, 2, 3, 4‚Ä¶)
‚Ä¢ T-shirt sizing (only if converted to numbers)
          </div>

          <div style="margin-top:10px; color:var(--text-muted); font-weight:800; line-height:1.6;">
            The forecast does NOT depend on what ‚Äú1 story point‚Äù means. It depends on velocity consistency over time.
          </div>

          <div style="margin-top:10px; color:var(--text-muted); font-weight:800; line-height:1.6;">
            ‚ö† Large jumps in scale (e.g., 16 ‚Üí 32) can increase volatility. If possible, slice large stories to make forecasts more reliable.
          </div>
        </div>

        <!-- INPUTS -->
        <div style="margin-top:16px;">
          <div class="kvKey">Inputs</div>

          <div style="display:grid; gap:12px;">
            <div>
              <div style="font-weight:900; margin-bottom:6px;">Sprint Days (working days)</div>
              <input class="fun-input" id="sprintDays" type="number" min="1" placeholder="e.g., 10">
            </div>

            <div>
              <div style="font-weight:900; margin-bottom:6px;">Team Members</div>
              <input class="fun-input" id="teamMembers" type="number" min="1" placeholder="e.g., 7">
            </div>

            <div>
              <div style="font-weight:900; margin-bottom:6px;">Leave Days (person-days)</div>
              <input class="fun-input" id="leaveDays" type="number" min="0" placeholder="e.g., 3">
              <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
                Example: 2 people taking 1 day off each = 2 leave days.
              </div>
            </div>

            <div>
              <div style="font-weight:900; margin-bottom:6px;">Interruptions (%)</div>
              <input class="fun-input" id="interruptPct" type="number" min="0" max="60" step="1" placeholder="e.g., 15">
              <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
                Support work, prod issues, ad-hoc meetings. Typical: 10‚Äì25%.
              </div>
            </div>

            <div class="info-banner" style="margin-top:0;">
              <div style="font-weight:900;">Last 3 Sprint Velocities (Completed SP)</div>
              <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
                Use <b>completed</b> story points (Definition of Done met), not committed.
              </div>

              <div style="display:grid; gap:10px; margin-top:12px;">
                <div>
                  <div style="font-weight:900; margin-bottom:6px;">Velocity N-1</div>
                  <input class="fun-input" id="v1" type="number" min="0" placeholder="e.g., 36">
                </div>

                <div>
                  <div style="font-weight:900; margin-bottom:6px;">Velocity N-2</div>
                  <input class="fun-input" id="v2" type="number" min="0" placeholder="e.g., 41">
                </div>

                <div>
                  <div style="font-weight:900; margin-bottom:6px;">Velocity N-3</div>
                  <input class="fun-input" id="v3" type="number" min="0" placeholder="e.g., 38">
                </div>
              </div>
            </div>
          </div>

          <div class="btnRow" style="margin-top:12px;">
            <button class="btnPrimary" id="calcBtn" type="button">Calculate üì¶</button>
            <button class="btnGhost" id="pullFromSetup" type="button">Use Setup Inputs</button>
            <button class="btnGhost" id="resetBtn" type="button">Reset</button>
          </div>
        </div>

        <!-- OUTPUT -->
        <div style="margin-top:18px;">
          <div class="kvKey">Results</div>

          <!-- Warnings -->
          <div class="info-banner" id="interruptWarn" style="display:none; margin-bottom:12px;">
            <div style="font-weight:900;">‚ö† High Interruptions Detected</div>
            <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
              Interruptions above <b>40%</b> usually means the team is heavily loaded with support/meetings.
              The forecast may be unreliable. Consider reducing scope or protecting focus time.
            </div>
          </div>

          <div class="info-banner" id="leaveWarn" style="display:none; margin-bottom:12px;">
            <div style="font-weight:900;">‚ö† Leave Days Look Too High</div>
            <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
              Your <b>leave days</b> exceed your <b>raw capacity</b>. This makes effective capacity negative.
              Check sprint days, team members, and leave days (person-days).
            </div>
          </div>

          <div class="info-banner" id="velocityWarn" style="display:none; margin-bottom:12px;">
            <div style="font-weight:900;">‚ö† Not Enough Velocity History</div>
            <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
              Forecasting is much weaker without past velocities.
              Add at least <b>2</b> completed sprint velocities (N-1, N-2) for a more reliable result.
            </div>
          </div>

          <div class="info-banner" id="spikeWarn" style="display:none; margin-bottom:12px;">
            <div style="font-weight:900;">‚ö† Forecast Is Much Higher Than Average Velocity</div>
            <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
              Your forecast is significantly higher than what the team typically delivers.
              This often indicates optimistic inputs (low interruptions/leave) or unusual sprint conditions.
              Consider using <b>Conservative</b> as your safe commitment.
            </div>
          </div>

          <div class="info-banner" id="resultsBox">
            <div id="rawCap">Raw Capacity: ‚Äî</div>
            <div id="effDays">Effective Days: ‚Äî</div>
            <div id="velPerDay">Velocity per Team-Day: ‚Äî</div>
            <div id="forecastSp">Forecast SP: ‚Äî</div>

            <hr style="margin:10px 0; opacity:.2;">

            <div id="consRange">Conservative: ‚Äî</div>
            <div id="likelyRange">Likely: ‚Äî</div>
            <div id="stretchRange">Stretch: ‚Äî</div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="js/theme.js"></script>
  <script src="js/xp.js"></script>

  <script>
    const $ = id => document.getElementById(id);

    function avg(arr){
      return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    }

    function round(n){ return Math.round(n*100)/100; }

    function show(id, yes){
      const el = $(id);
      if (!el) return;
      el.style.display = yes ? "block" : "none";
    }

    function calculate(){
      const sprintDays = Number($("sprintDays").value) || 0;
      const teamMembers = Number($("teamMembers").value) || 0;
      const leaveDays = Number($("leaveDays").value) || 0;

      const interruptPctRaw = Number($("interruptPct").value) || 0;
      const interruptPct = interruptPctRaw / 100;

      const velocities = [
        Number($("v1").value),
        Number($("v2").value),
        Number($("v3").value)
      ].filter(v => v > 0);

      const rawCap = sprintDays * teamMembers;                     // team-days
      const effectiveBase = (rawCap - leaveDays);                  // team-days
      const effDays = effectiveBase * (1 - interruptPct);          // effective team-days
      const avgVel = avg(velocities);                              // SP per sprint
      const velPerDay = rawCap > 0 ? avgVel / rawCap : 0;          // SP per team-day
      const forecast = (effDays > 0 && velPerDay > 0) ? effDays * velPerDay : 0; // SP

      // Warnings
      show("interruptWarn", interruptPctRaw > 40);
      show("leaveWarn", rawCap > 0 && leaveDays > rawCap);
      show("velocityWarn", velocities.length < 2);
      show("spikeWarn", avgVel > 0 && forecast > (avgVel * 1.15));

      $("rawCap").textContent = rawCap > 0 ? `Raw Capacity: ${rawCap} team-days` : `Raw Capacity: ‚Äî`;

      $("effDays").textContent = rawCap > 0
        ? `Effective Days: ${round(effDays)} effective team-days`
        : `Effective Days: ‚Äî`;

      $("velPerDay").textContent = (rawCap > 0 && avgVel > 0)
        ? `Velocity per Team-Day: ${round(velPerDay)} SP / team-day`
        : `Velocity per Team-Day: ‚Äî`;

      $("forecastSp").textContent = forecast > 0
        ? `Forecast SP: ${round(forecast)} story points`
        : `Forecast SP: ‚Äî`;

      $("consRange").textContent = forecast > 0 ? `Conservative: ${Math.floor(forecast*0.9)} SP` : `Conservative: ‚Äî`;
      $("likelyRange").textContent = forecast > 0 ? `Likely: ${Math.round(forecast)} SP` : `Likely: ‚Äî`;
      $("stretchRange").textContent = forecast > 0 ? `Stretch: ${Math.ceil(forecast*1.05)} SP` : `Stretch: ‚Äî`;
    }

    $("calcBtn").addEventListener("click", calculate);

    $("resetBtn").addEventListener("click", () => {
      document.querySelectorAll("input.fun-input").forEach(i => i.value = "");
      calculate();
    });

    $("pullFromSetup").addEventListener("click", () => {
      const setup = JSON.parse(localStorage.getItem("scrummer_setup_v1") || "{}");
      if(setup){
        $("sprintDays").value = setup.sprintDays || "";
        $("teamMembers").value = setup.teamMembers || "";
        $("leaveDays").value = setup.leaveDays || "";
        $("v1").value = setup.v1 || "";
        $("v2").value = setup.v2 || "";
        $("v3").value = setup.v3 || "";
      }
      calculate();
    });

    $("toggleExplain").addEventListener("click", () => {
      const box = $("explainBox");
      const btn = $("toggleExplain");
      const open = box.style.display === "block";
      box.style.display = open ? "none" : "block";
      btn.textContent = open ? "Show Details" : "Hide Details";
    });

    calculate();
  </script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supa.js"></script>

</body>
</html>