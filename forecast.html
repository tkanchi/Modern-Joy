<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Scrummer â€” Forecast</title>
  <link rel="stylesheet" href="css/style.css?v=3"/>
</head>

<body>
  <div class="appShell">

    <!-- SIDEBAR -->
    <aside class="sideNav">
      <div class="sideBrand">
        <div class="brandMark">ğŸ†</div>
        <div>
          <div class="brandName">SCRUMMER</div>
          <div class="brandTag">Gamified Scrum OS</div>
        </div>
      </div>

      <nav class="nav">
        <a class="navlink" href="index.html">ğŸš€ Setup</a>
        <a class="navlink" href="intelligence.html">ğŸ“Š Insights</a>
        <a class="navlink" href="suggestions.html">ğŸ¯ Actions</a>
        <a class="navlink" href="workspace.html">ğŸ¤– Copilot</a>
        <a class="navlink active" href="forecast.html">ğŸ“¦ Forecast</a>
        <a class="navlink" href="gamerules.html">ğŸ® Game Rules</a>
      </nav>

      <!-- XP WIDGET -->
      <div class="xpWidget">
        <div class="xpTop">
          <div>
            <div class="lvl" id="xpLevel">Level 1</div>
            <div class="title" id="xpTitle">Rookie</div>
          </div>
          <div id="moodBadge">ğŸ† Calm</div>
        </div>

        <div class="xpBar">
          <div class="xpFill" id="xpFill"></div>
        </div>

        <div class="xpMeta">
          <span id="xpText">0 / 300 XP</span>
          <span id="streakText">ğŸ§Š streak reset</span>
        </div>
      </div>

      <button class="themeToggle" id="themeToggle" type="button">
        Theme: <span id="themeMode">Light</span>
      </button>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="sectionCard">
        <h1 class="sectionTitle">Capacity Forecast</h1>
        <p class="sectionSub">Pure math. Transparent formulas. No AI. No hidden assumptions.</p>

        <div class="info-banner">
          <strong>Purpose:</strong> Estimate realistic Sprint commitment before planning begins.
        </div>

        <!-- ===================================================== -->
        <!-- FORECAST MATH EXPLANATION -->
        <!-- ===================================================== -->
        <div class="info-banner" style="margin-top:14px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:900;">ğŸ“– How Forecast Is Calculated</div>
            <button class="btnGhost" type="button" id="toggleExplain" style="padding:6px 10px; font-size:12px;">
              Show Details
            </button>
          </div>

          <div id="explainBox" style="display:none; margin-top:14px; color:var(--text-muted); font-weight:800; line-height:1.6;">

            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">1) Raw Capacity</div>
              Raw Capacity = Sprint Days Ã— Team Members
              <div style="margin-top:6px;">
                Total theoretical working days before accounting for leave or interruptions.
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">2) Effective Team Days</div>
              Effective Days = (Raw Capacity âˆ’ Leave Days) Ã— (1 âˆ’ Interruptions%)
              <div style="margin-top:6px;">
                Subtract time-off, then reduce remaining capacity by expected overhead.
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">3) Velocity per Team Day</div>
              Velocity/Day = Average Velocity Ã· Raw Capacity
              <div style="margin-top:6px;">
                Converts historical output into delivery rate per team-day.
              </div>
            </div>

            <div style="margin-bottom:12px;">
              <div style="font-weight:900; color:var(--text-main);">4) Forecast Story Points</div>
              Forecast SP = Effective Days Ã— Velocity/Day
              <div style="margin-top:6px;">
                Realistic estimate based on usable time and past throughput.
              </div>
            </div>

            <div style="margin-top:10px;">
              <div style="font-weight:900; color:var(--text-main);">Commitment Range</div>
              Conservative = Forecast âˆ’ 10% <br/>
              Likely = Forecast <br/>
              Stretch = Forecast + 5%
              <div style="margin-top:6px;">
                Forecasting is probabilistic, so we show a safe band instead of a single number.
              </div>
            </div>

            <div style="margin-top:14px; font-size:12px;">
              Based on standard Scrum capacity planning concepts, Sprint Planning guidance,
              and industry practices around velocity and focus factor.
            </div>

          </div>
        </div>

        <!-- ===================================================== -->
        <!-- ESTIMATION SCALE COMPATIBILITY -->
        <!-- ===================================================== -->
        <div class="info-banner" style="margin-top:14px;">
          <div style="font-weight:900;">ğŸ“ Estimation Scale Compatibility</div>

          <div style="margin-top:8px; color:var(--text-muted); font-weight:800; line-height:1.6;">
            Scrummer Forecast works with any consistent estimation scale, as long as your historical velocity uses the same scale.
          </div>

          <div style="margin-top:8px; color:var(--text-muted); font-weight:800; line-height:1.6; white-space:pre-line;">
â€¢ Fibonacci (1, 2, 3, 5, 8, 13â€¦)
â€¢ Modified scales (1, 2, 4, 6, 8, 16, 32â€¦) âœ…
â€¢ Linear scales (1, 2, 3, 4â€¦)
â€¢ T-shirt sizing (only if converted to numbers)
          </div>

          <div style="margin-top:10px; color:var(--text-muted); font-weight:800; line-height:1.6;">
            The forecast does NOT depend on what â€œ1 story pointâ€ means. It depends on velocity consistency over time.
          </div>

          <div style="margin-top:10px; color:var(--text-muted); font-weight:800; line-height:1.6;">
            âš  Large jumps in scale (e.g., 16 â†’ 32) can increase volatility. If possible, slice large stories to make forecasts more reliable.
          </div>
        </div>

        <!-- INPUTS -->
        <div style="margin-top:16px;">
          <div class="kvKey">Inputs</div>

          <div style="display:grid; gap:12px;">
            <div>
              <div style="font-weight:900; margin-bottom:6px;">Sprint Days (working days)</div>
              <input class="fun-input" id="sprintDays" type="number" min="1" placeholder="e.g., 10">
            </div>

            <div>
              <div style="font-weight:900; margin-bottom:6px;">Team Members</div>
              <input class="fun-input" id="teamMembers" type="number" min="1" placeholder="e.g., 7">
            </div>

            <div>
              <div style="font-weight:900; margin-bottom:6px;">Leave Days (person-days)</div>
              <input class="fun-input" id="leaveDays" type="number" min="0" placeholder="e.g., 3">
              <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
                Example: 2 people taking 1 day off each = 2 leave days.
              </div>
            </div>

            <div>
              <div style="font-weight:900; margin-bottom:6px;">Interruptions (%)</div>
              <input class="fun-input" id="interruptPct" type="number" min="0" max="60" step="1" placeholder="e.g., 15">
              <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
                Support work, prod issues, ad-hoc meetings. Typical: 10â€“25%.
              </div>
            </div>

            <div class="info-banner" style="margin-top:0;">
              <div style="font-weight:900;">Last 3 Sprint Velocities (Completed SP)</div>
              <div style="color:var(--text-muted); font-weight:800; margin-top:6px;">
                Use <b>completed</b> story points (Definition of Done met), not committed.
              </div>

              <div style="display:grid; gap:10px; margin-top:12px;">
                <div>
                  <div style="font-weight:900; margin-bottom:6px;">Velocity N-1</div>
                  <input class="fun-input" id="v1" type="number" min="0" placeholder="e.g., 36">
                </div>

                <div>
                  <div style="font-weight:900; margin-bottom:6px;">Velocity N-2</div>
                  <input class="fun-input" id="v2" type="number" min="0" placeholder="e.g., 41">
                </div>

                <div>
                  <div style="font-weight:900; margin-bottom:6px;">Velocity N-3</div>
                  <input class="fun-input" id="v3" type="number" min="0" placeholder="e.g., 38">
                </div>
              </div>
            </div>
          </div>

          <div class="btnRow" style="margin-top:12px;">
            <button class="btnPrimary" id="calcBtn" type="button">Calculate ğŸ“¦</button>
            <button class="btnGhost" id="pullFromSetup" type="button">Use Setup Inputs</button>
            <button class="btnGhost" id="resetBtn" type="button">Reset</button>
          </div>
        </div>

        <!-- OUTPUT -->
        <div style="margin-top:18px;">
          <div class="kvKey">Results</div>

          <div class="info-banner" id="resultsBox">
            <div id="rawCap">Raw Capacity: â€”</div>
            <div id="effDays">Effective Days: â€”</div>
            <div id="velPerDay">Velocity per Day: â€”</div>
            <div id="forecastSp">Forecast SP: â€”</div>

            <hr style="margin:10px 0; opacity:.2;">

            <div id="consRange">Conservative: â€”</div>
            <div id="likelyRange">Likely: â€”</div>
            <div id="stretchRange">Stretch: â€”</div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="js/theme.js"></script>
  <script src="js/xp.js"></script>

  <script>
    const $ = id => document.getElementById(id);

    function avg(arr){
      return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    }

    function round(n){ return Math.round(n*100)/100; }

    function calculate(){
      const sprintDays = Number($("sprintDays").value) || 0;
      const teamMembers = Number($("teamMembers").value) || 0;
      const leaveDays = Number($("leaveDays").value) || 0;
      const interruptPct = (Number($("interruptPct").value) || 0) / 100;

      const velocities = [
        Number($("v1").value),
        Number($("v2").value),
        Number($("v3").value)
      ].filter(v => v > 0);

      const rawCap = sprintDays * teamMembers;
      const effDays = (rawCap - leaveDays) * (1 - interruptPct);
      const avgVel = avg(velocities);
      const velPerDay = rawCap > 0 ? avgVel / rawCap : 0;
      const forecast = effDays * velPerDay;

      $("rawCap").textContent = `Raw Capacity: ${rawCap}`;
      $("effDays").textContent = `Effective Days: ${round(effDays)}`;
      $("velPerDay").textContent = `Velocity per Day: ${round(velPerDay)}`;
      $("forecastSp").textContent = `Forecast SP: ${round(forecast)}`;

      $("consRange").textContent = `Conservative: ${Math.floor(forecast*0.9)}`;
      $("likelyRange").textContent = `Likely: ${Math.round(forecast)}`;
      $("stretchRange").textContent = `Stretch: ${Math.ceil(forecast*1.05)}`;
    }

    $("calcBtn").addEventListener("click", calculate);

    $("resetBtn").addEventListener("click", () => {
      document.querySelectorAll("input.fun-input").forEach(i => i.value = "");
      calculate();
    });

    $("pullFromSetup").addEventListener("click", () => {
      const setup = JSON.parse(localStorage.getItem("scrummer_setup_v1") || "{}");
      if(setup){
        $("sprintDays").value = setup.sprintDays || "";
        $("teamMembers").value = setup.teamMembers || "";
        $("leaveDays").value = setup.leaveDays || "";
        $("v1").value = setup.v1 || "";
        $("v2").value = setup.v2 || "";
        $("v3").value = setup.v3 || "";
      }
      calculate();
    });

    // Explanation toggle
    $("toggleExplain").addEventListener("click", () => {
      const box = $("explainBox");
      const btn = $("toggleExplain");
      const open = box.style.display === "block";
      box.style.display = open ? "none" : "block";
      btn.textContent = open ? "Show Details" : "Hide Details";
    });

    calculate();
  </script>

</body>
</html>